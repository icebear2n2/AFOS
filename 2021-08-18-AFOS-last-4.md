---
title:  "[AWS] 10주차 -4 AutoScaling 그룹을 이용하여 WebSrvs 구성"
subtitle:   "AutoScaling 그룹을 이용하여 WebSrvs 구성"
date: 2021-08-18 15:30:00
categories: AWS
tags: AFOS[2기]
---

## 최종 구성
<img src="/css/images/1313.png">

EC2 -> EC2 시작 템플릿 생성 -> 아래 내용 입력 후 `시작 템플릿 생성` 클릭

```bash
시작 템플릿 이름 : WPEC2LaunchTemplate
설명 : Wordpress Web Auto Scaling v1.0
Auto Scaling 지침 : 체크
AMI : Amazon Linux 2 AMI(HVM), SSD Volume Type - 아키텍처 : 64비트(x86)
인스턴스 유형 : t2.micro
키 페어 : (각자 자신의 SSH 키페어 선택)
네트워킹 플랫폼 : VPC
보안 그룹 : ###-WP-VPC1SG-### 포함된것 선택
리소스 태그 : 키(Lab) , 값(WPLab)
고급 세부 정보 ← 클릭
- IAM 인스턴스 프로파일 : WPLabInstanceProfile
- 세부 CloudWatch 모니터링 : 활성화
- 사용자 데이터 : 아래 내용 복붙!
```

**아래 EFS 사용 시 각자 자신의 EFS 파일시스템 ID로 변경할 것**
```bash
#!/bin/bash
amazon-linux-extras install lamp-mariadb10.2-php7.2 php7.2 -y
yum install httpd htop amazon-efs-utils tree -y
systemctl start httpd && systemctl enable httpd
yum install gcc php-xml php-mbstring php-sodium php-devel php-pear ImageMagick-devel ghostscript -y
cat <<EOT> /etc/php.d/40-imagick.ini
extension = imagick.so
EOT
printf "\n" | pecl install imagick
sed -i 's/^upload_max_filesize = 2M/upload_max_filesize = 64M/g' /etc/php.ini
sed -i 's/^post_max_size = 8M/post_max_size = 64M/g' /etc/php.ini
sed -i 's/^max_execution_time = 30/max_execution_time = 300/g' /etc/php.ini
sed -i 's/^memory_limit = 128M/memory_limit = -1/g' /etc/php.ini
mkdir -p /var/www/wordpress/
mount -t efs 자신의EFS파일시스템ID:/ /var/www/wordpress
chown -R apache:apache /var/www
chmod 2775 /var/www
find /var/www -type d -exec chmod 2775 {} \;
find /var/www -type f -exec chmod 0664 {} \;
chmod u+wrx /var/www/wordpress/wp-content/*
echo 'ServerName 127.0.0.1:80' >> /etc/httpd/conf.d/MyBlog.conf
echo 'DocumentRoot /var/www/wordpress' >> /etc/httpd/conf.d/MyBlog.conf
echo '<Directory /var/www/wordpress>' >> /etc/httpd/conf.d/MyBlog.conf
echo '  Options Indexes FollowSymLinks' >> /etc/httpd/conf.d/MyBlog.conf
echo '  AllowOverride All' >> /etc/httpd/conf.d/MyBlog.conf
echo '  Require all granted' >> /etc/httpd/conf.d/MyBlog.conf
echo '</Directory>' >> /etc/httpd/conf.d/MyBlog.conf
systemctl restart php-fpm
systemctl restart httpd
```

생성된 시작 템플릿 

`시작 템플릿 생성` 클릭
<img width="307" alt="스크린샷 2021-08-20 오후 9 05 17" src="https://user-images.githubusercontent.com/87232411/130241220-75fe5043-fa33-4f20-bb9f-4478c4e17fd9.png">

```bash
시작 템플릿 이름 : WPEC2LaunchTemplate
설명 : Wordpress Web Auto Scaling v1.0
Auto Scaling 지침 : 체크
```

<img width="868" alt="스크린샷 2021-08-20 오후 9 05 39" src="https://user-images.githubusercontent.com/87232411/130241224-df092a36-016e-44bd-854b-4b55a01fe4fa.png">

```bash

AMI : Amazon Linux 2 AMI(HVM), SSD Volume Type - 아키텍처 : 64비트(x86)
인스턴스 유형 : t2.micro
키 페어 : (각자 자신의 SSH 키페어 선택)
```

<img width="867" alt="스크린샷 2021-08-20 오후 9 05 56" src="https://user-images.githubusercontent.com/87232411/130241227-76a7d059-b314-425b-bc0e-743ea6139649.png">
```bash
네트워킹 플랫폼 : VPC
보안 그룹 : ###-WP-VPC1SG-### 포함된것 선택
```

<img width="850" alt="스크린샷 2021-08-20 오후 9 06 36" src="https://user-images.githubusercontent.com/87232411/130241237-ce8f2829-bc6b-411c-8424-75c3c4412ea3.png">
```bash
리소스 태그 : 키(Lab) , 값(WPLab)
```

<img width="839" alt="스크린샷 2021-08-20 오후 9 06 58" src="https://user-images.githubusercontent.com/87232411/130241239-375dd296-3dcb-4913-9d67-37d6f7e44bd7.png">

```bash
IAM 인스턴스 프로파일 : WPLabInstanceProfile
세부 CloudWatch 모니터링 : 활성화
사용자 데이터 : 아래 내용 복붙!
```

**아래 EFS 사용 시 각자 자신의 EFS 파일 시스템 ID로 변경할 것**
```bash
#!/bin/bash
amazon-linux-extras install lamp-mariadb10.2-php7.2 php7.2 -y
yum install httpd htop amazon-efs-utils tree -y
systemctl start httpd && systemctl enable httpd
yum install gcc php-xml php-mbstring php-sodium php-devel php-pear ImageMagick-devel ghostscript -y
cat <<EOT> /etc/php.d/40-imagick.ini
extension = imagick.so
EOT
printf "\n" | pecl install imagick
sed -i 's/^upload_max_filesize = 2M/upload_max_filesize = 64M/g' /etc/php.ini
sed -i 's/^post_max_size = 8M/post_max_size = 64M/g' /etc/php.ini
sed -i 's/^max_execution_time = 30/max_execution_time = 300/g' /etc/php.ini
sed -i 's/^memory_limit = 128M/memory_limit = -1/g' /etc/php.ini
mkdir -p /var/www/wordpress/
mount -t efs **자신의EFS파일시스템ID**:/ /var/www/wordpress
chown -R apache:apache /var/www
chmod 2775 /var/www
find /var/www -type d -exec chmod 2775 {} \;
find /var/www -type f -exec chmod 0664 {} \;
chmod u+wrx /var/www/wordpress/wp-content/*
echo 'ServerName 127.0.0.1:80' >> /etc/httpd/conf.d/MyBlog.conf
echo 'DocumentRoot /var/www/wordpress' >> /etc/httpd/conf.d/MyBlog.conf
echo '<Directory /var/www/wordpress>' >> /etc/httpd/conf.d/MyBlog.conf
echo '  Options Indexes FollowSymLinks' >> /etc/httpd/conf.d/MyBlog.conf
echo '  AllowOverride All' >> /etc/httpd/conf.d/MyBlog.conf
echo '  Require all granted' >> /etc/httpd/conf.d/MyBlog.conf
echo '</Directory>' >> /etc/httpd/conf.d/MyBlog.conf
systemctl restart php-fpm
systemctl restart httpd
```
<img width="834" alt="스크린샷 2021-08-20 오후 9 07 17" src="https://user-images.githubusercontent.com/87232411/130241242-c0e9aa8c-3660-4fc0-a814-dc32bf2e81ae.png">
<img width="705" alt="스크린샷 2021-08-20 오후 9 07 32" src="https://user-images.githubusercontent.com/87232411/130241251-8686752c-d9d1-4bde-afe8-b92ed6f7f690.png">

`시작 템플릿 생성` 클릭
<img width="831" alt="스크린샷 2021-08-20 오후 9 07 49" src="https://user-images.githubusercontent.com/87232411/130241254-d9673a56-af78-4266-a307-ac0fcf06e92b.png">

작업 -> `Auto Scaling 그룹 생성` 클릭
<img width="1126" alt="스크린샷 2021-08-20 오후 9 08 03" src="https://user-images.githubusercontent.com/87232411/130241262-a7d58eee-eaca-4c72-97ad-1bb07a2cdc89.png">

```bash
Auto Scaling 그룹 이름 : FirstEC2AutoScalingGroup
시작 템플릿 : WPEC2LaunchTemplate
```
<img width="853" alt="스크린샷 2021-08-20 오후 9 08 22" src="https://user-images.githubusercontent.com/87232411/130241277-e986e8a1-7e27-47e8-941a-b6a3db76a5d5.png">

`다음` 클릭
<img width="190" alt="스크린샷 2021-08-20 오후 9 08 27" src="https://user-images.githubusercontent.com/87232411/130241284-6e959ca2-281f-4e5e-8c21-caa50ec3cfe3.png">

```bash
인스턴스 구매 옵션 : 시작 템플릿 준수
네트워크 - VPC : WP-VPC1
네트워크 - 서브넷 : WP-VPC1-Subnet-1, WP-VPC1-Subnet-2
```

`다음` 클릭
<img width="846" alt="스크린샷 2021-08-20 오후 9 10 10" src="https://user-images.githubusercontent.com/87232411/130241289-94e6dfc3-c5ea-484b-acfc-97b2cca1d519.png">
<img width="839" alt="스크린샷 2021-08-20 오후 9 10 15" src="https://user-images.githubusercontent.com/87232411/130241296-d33650ea-12e5-4e0e-9d43-81b2a3748d64.png">

```bash
로드 밸런싱 : 기존 로드 밸런서에 연결
로그 밸런서 대상 그룹에서 선택 : 선택
기존 로드 밸런서 대상 그룹 : ALB-TG
상태 확인 유형 : ELB (Check)
상태 확인 유예 기간 : 60초
모니터링 - CloudWatch 내에서 그룹 지표 수집 활성화 : 체크
```
<img width="845" alt="스크린샷 2021-08-20 오후 9 10 36" src="https://user-images.githubusercontent.com/87232411/130241299-f7b38541-ce1a-4666-8d36-1115e6e96a8a.png">

`다음` 클릭
<img width="847" alt="스크린샷 2021-08-20 오후 9 10 57" src="https://user-images.githubusercontent.com/87232411/130241304-9c5696da-4ed6-44b9-881c-380fc3179c66.png">

```bash
원하는 용량 : 2
최소 용량 : 2
최대 용량 : 4
조정 정책 : 대상 추척 조정 정책
조정 정책 이름 : Scale Out Policy
대상 값 : 30 → 3분 동안 3번 연속 CPU 30% 경우(1분 마다 기록)
인스턴스 요구 사항 : 60초 → 지표에 포함하기 전 워밍업 시간(초)
확대 정책만 생성하려면 축소 비활성화 : Check → 축소 설정하지 않음
인스턴스 축소 보호 활성화 : UnCheck
```
<img width="840" alt="스크린샷 2021-08-20 오후 9 11 07" src="https://user-images.githubusercontent.com/87232411/130241306-a9b94963-4f61-4150-aa30-89950c8d477d.png">
<img width="845" alt="스크린샷 2021-08-20 오후 9 11 41" src="https://user-images.githubusercontent.com/87232411/130241308-0e0e0377-beb4-4084-8e41-a20ae4df4f1c.png">

`다음` 클릭
<img width="838" alt="스크린샷 2021-08-20 오후 9 11 46" src="https://user-images.githubusercontent.com/87232411/130241314-0d922c44-f343-4b1c-8edd-54f058d33519.png">

`다음` 클릭
<img width="219" alt="스크린샷 2021-08-20 오후 9 11 50" src="https://user-images.githubusercontent.com/87232411/130241320-e47c5a74-cb2e-4613-a4d0-c25e791c95b4.png">

```bash
태그 : 키(Name) , 값(WebServers)
```

`다음` 클릭
<img width="848" alt="스크린샷 2021-08-20 오후 9 12 08" src="https://user-images.githubusercontent.com/87232411/130241323-dc8fcd6f-d5b5-4ace-b8f6-96539238b192.png">

`AutoScaling 그룹 생성` 클릭
<img width="296" alt="스크린샷 2021-08-20 오후 9 12 14" src="https://user-images.githubusercontent.com/87232411/130241326-1d822de3-52f7-4ddf-a39f-ade7a95c58fc.png">

EC2 2개가 생성 됨
<img width="1113" alt="스크린샷 2021-08-20 오후 9 13 02" src="https://user-images.githubusercontent.com/87232411/130241328-bcdb3225-1747-4e33-9317-b8ef3fa7e06f.png">
<img width="1159" alt="스크린샷 2021-08-20 오후 9 23 42" src="https://user-images.githubusercontent.com/87232411/130241337-1b0e9199-e876-4d4e-8d06-3c0f1a9c3b6a.png">

워드프레스 사이트도 접속이 됩니다.
<img width="1437" alt="스크린샷 2021-08-20 오후 9 25 52" src="https://user-images.githubusercontent.com/87232411/130241345-6b995f19-66a8-40b7-863f-85409b192eed.png">\

## CPU 부하 발생 및 Auto Scaling 확인

```bash
# 웹 접속 테스트 (리전, 인스턴스ID, Private IP)
WPDNS=cloudfront.net
Web1=퍼블릭 주소
Web2=퍼블릭 주소

# 터미널1 - 1개 요청(풀)로 총합 500번 요청 진행
ab -n 500 -c 1 http://$Web1/load.php

# 터미널2 - 20개 요청(풀)로 총합 1000번 요청 진행
ab -n 1000 -c 20 http://$Web2/load.php
ab -n 1000 -c 20 http://$WPDNS/load.php

# 접속 되는 EC2 마다 현재 CPU 부하 출력
while true; do curl $WPDNS/xff.php --silent --connect-timeout 1; date; echo "---[AutoScaling]---"; sleep 1; done

# EC2 증가 이후 증감 확인
for i in {1..100}; do curl $WPDNS/xff.php --silent;echo ; done | sort | uniq -c | sort -nr
```
<img width="455" alt="스크린샷 2021-08-20 오후 9 28 04" src="https://user-images.githubusercontent.com/87232411/130241351-4cc84d39-d8d6-4dda-968d-6bd674f49ad0.png">
<img width="668" alt="스크린샷 2021-08-20 오후 9 32 58" src="https://user-images.githubusercontent.com/87232411/130241354-90d70e94-a659-4a3b-991d-7d3ba5678968.png">

새로 생성된 EC2 두개가 ALB 타겟그룹에 포함되어 있습니다
<img width="1139" alt="스크린샷 2021-08-20 오후 9 33 24" src="https://user-images.githubusercontent.com/87232411/130241361-c0dd98ed-e013-4fae-9ad7-6789571ebc30.png">
<img width="543" alt="스크린샷 2021-08-20 오후 9 37 26" src="https://user-images.githubusercontent.com/87232411/130241375-c9b0e953-a3b8-4586-b544-51c1ba6f93bc.png">
<img width="597" alt="스크린샷 2021-08-20 오후 9 37 51" src="https://user-images.githubusercontent.com/87232411/130241379-b5a0bc22-632f-4af9-b53e-1edf20d57da1.png">
<img width="1045" alt="스크린샷 2021-08-20 오후 9 38 11" src="https://user-images.githubusercontent.com/87232411/130241382-507c6a65-1015-45be-a877-1df472fa7635.png">
<img width="559" alt="스크린샷 2021-08-20 오후 9 38 17" src="https://user-images.githubusercontent.com/87232411/130241394-6428981a-0fa4-40a6-b6a4-92660802828b.png">
<img width="528" alt="스크린샷 2021-08-20 오후 9 38 23" src="https://user-images.githubusercontent.com/87232411/130241397-e1b095ab-bde6-42a3-ae48-411c368472d0.png">

EC2가 4개로 증가했습니다
<img width="1023" alt="스크린샷 2021-08-20 오후 9 38 46" src="https://user-images.githubusercontent.com/87232411/130241400-f520a5b7-49c3-494a-aafc-221428f4c777.png">

CPU 사용률을 비교해봅시다
<img width="1330" alt="스크린샷 2021-08-20 오후 9 40 00" src="https://user-images.githubusercontent.com/87232411/130241409-065876f0-bf6e-4220-aa0b-e3a98eb58a0a.png">

1시간으로 바꿔줍니다
<img width="592" alt="스크린샷 2021-08-20 오후 9 38 58" src="https://user-images.githubusercontent.com/87232411/130241407-5169b7b5-cad9-4f8b-b3d1-b6d77247968c.png">

이렇게 변화했네요
<img width="415" alt="스크린샷 2021-08-20 오후 9 40 06" src="https://user-images.githubusercontent.com/87232411/130241413-40307efd-0199-4b6f-a08d-1c0544d4d75c.png">
<img width="1328" alt="스크린샷 2021-08-20 오후 9 41 54" src="https://user-images.githubusercontent.com/87232411/130241415-c3c08088-a845-4e01-90c0-a56427374d24.png">

EC2가 4개로 증가했습니다
<img width="940" alt="스크린샷 2021-08-20 오후 9 42 06" src="https://user-images.githubusercontent.com/87232411/130241422-56c78a88-b984-42fd-994e-17d7ceea2f09.png">

타겟그룹에도 포함되고 있습니다
<img width="1158" alt="스크린샷 2021-08-20 오후 9 42 54" src="https://user-images.githubusercontent.com/87232411/130241429-cca2c2bc-1244-43b2-9cbe-86cb65ed3797.png">

EC2에서도 확인할 수 있습니다

```bash
for i in {1..100}; do curl $WPDNS/xff.php --silent;echo ; done | sort | uniq -c | sort -n
```
<img width="666" alt="스크린샷 2021-08-20 오후 9 50 12" src="https://user-images.githubusercontent.com/87232411/130241468-f6d217a9-cb36-4f95-971a-c93ba30fb1e5.png">

<br/>
<br/>
<br/>

<hr/>

**참고 자료: AFOS[2기] 노션 내용**