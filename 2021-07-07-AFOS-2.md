---
title:  "[AWS] 5주차-2 보안 실습"
subtitle:   "보안 실습"
date: 2021-07-07 23:00:00
categories: AWS
tags: AFOS[2기]
---

## 실습) IAM User 생성 및 로그인

IAM -> `사용자` 클릭
<img width="215" alt="스크린샷 2021-07-07 오후 11 46 05" src="https://user-images.githubusercontent.com/86812249/124787372-68fc3100-df83-11eb-9248-51d91a62dcf2.png">

`사용자 추가` 클릭
<img width="131" alt="스크린샷 2021-07-07 오후 11 46 12" src="https://user-images.githubusercontent.com/86812249/124787373-68fc3100-df83-11eb-8036-056e399b4c02.png">

`사용자 이름 : admin`. 
`프로그래밍 방식 엑세스`, `AWS Management Console 액세스`  선택 후 ->  비밀번호 설정 -> `다음: 권한` 클릭
<img width="1063" alt="스크린샷 2021-07-07 오후 11 46 43" src="https://user-images.githubusercontent.com/86812249/124787378-6994c780-df83-11eb-9faf-4f9ebf7d35d1.png">

상단 오른쪽에 `기존 정책 직접 연결` 클릭
<img width="428" alt="스크린샷 2021-07-07 오후 11 46 50" src="https://user-images.githubusercontent.com/86812249/124787381-6a2d5e00-df83-11eb-8e41-b4bce692bad9.png">

`AdministratorAccess` 체크
<img width="826" alt="스크린샷 2021-07-07 오후 11 46 57" src="https://user-images.githubusercontent.com/86812249/124787382-6ac5f480-df83-11eb-8cee-765a09655059.png">

하단에 `다음: 태그` 클릭
<img width="211" alt="스크린샷 2021-07-07 오후 11 47 02" src="https://user-images.githubusercontent.com/86812249/124787384-6ac5f480-df83-11eb-89bd-03dd9e39a8d5.png">

기본 값으로 둔 후 -> `다음: 검토` 클릭
<img width="151" alt="스크린샷 2021-07-07 오후 11 47 28" src="https://user-images.githubusercontent.com/86812249/124787387-6b5e8b00-df83-11eb-91f5-0fcb016b878d.png">

하단에 `사용자 만들기` 클릭
<img width="199" alt="스크린샷 2021-07-07 오후 11 47 35" src="https://user-images.githubusercontent.com/86812249/124787388-6bf72180-df83-11eb-90f1-d79039d516f7.png">

이 뒤로 닫기를 누르면 다시는 액세스키를 볼 수 없으니, `.csv 다운로드` 클릭해주자
<img width="351" alt="스크린샷 2021-07-07 오후 11 47 46" src="https://user-images.githubusercontent.com/86812249/124787392-6bf72180-df83-11eb-869c-08e8e256fe21.png">

다음 계정도 똑같이 만들어 주자  
`사용자 이름: viewuser`. 
`AWS Management Console 액세스` 만 체크 후 -> 비밀 번호 설정 -> `다음: 권한` 클릭
<img width="1081" alt="스크린샷 2021-07-07 오후 11 48 18" src="https://user-images.githubusercontent.com/86812249/124787397-6c8fb800-df83-11eb-971f-4f2493f57c1e.png">

상단 오른쪽에 `기존 정책 직접 연결` 클릭
<img width="352" alt="스크린샷 2021-07-07 오후 11 48 43" src="https://user-images.githubusercontent.com/86812249/124787400-6d284e80-df83-11eb-8f79-6a736cfbec75.png">

`view`를 검색 후, `ViewOnlyAccess` 클릭 -> `다음: 태그` 클릭
<img width="1035" alt="스크린샷 2021-07-07 오후 11 48 59" src="https://user-images.githubusercontent.com/86812249/124787402-6d284e80-df83-11eb-9b54-ed1d5d0f8376.png">

기본 값으로 둔 후 -> `다음: 검토` 클릭
<img width="142" alt="스크린샷 2021-07-07 오후 11 49 07" src="https://user-images.githubusercontent.com/86812249/124787404-6dc0e500-df83-11eb-8a1c-eddfa3ffefbf.png">

하단에 `사용자 만들기` 클릭
<img width="152" alt="스크린샷 2021-07-07 오후 11 49 11" src="https://user-images.githubusercontent.com/86812249/124787408-6e597b80-df83-11eb-97b0-9ae355c0245a.png">

view는 액세스키 사용할 일이 없으니 굳이 저장하지 말자
<img width="1053" alt="스크린샷 2021-07-07 오후 11 49 23" src="https://user-images.githubusercontent.com/86812249/124787410-6e597b80-df83-11eb-9013-817c7c491916.png">

IAM 'admin' 으로 로그인 해보자 (다른 브라우저로 접속 권장, 다시 로그인하기 귀찮기 때문에 ㅎㅎ...)
<img width="392" alt="스크린샷 2021-07-07 오후 11 50 30" src="https://user-images.githubusercontent.com/86812249/124787412-6ef21200-df83-11eb-9017-55118e253828.png">

s3 -> `버킷 만들기` 클릭
<img width="187" alt="스크린샷 2021-07-07 오후 11 51 50" src="https://user-images.githubusercontent.com/86812249/124787413-6f8aa880-df83-11eb-8fd9-f617f07f8a22.png">

이름 마음대로 설정 후, `버킷 만들기` 클릭
<img width="759" alt="스크린샷 2021-07-07 오후 11 52 14" src="https://user-images.githubusercontent.com/86812249/124787415-6f8aa880-df83-11eb-887d-865a0c01a6e8.png">
<img width="203" alt="스크린샷 2021-07-07 오후 11 52 17" src="https://user-images.githubusercontent.com/86812249/124787416-70233f00-df83-11eb-9f9a-d844b0fd103d.png">

만들어졌습니당
<img width="910" alt="스크린샷 2021-07-07 오후 11 52 58" src="https://user-images.githubusercontent.com/86812249/124787418-70bbd580-df83-11eb-93c3-8b03e5770a75.png">

`삭제` 클릭 -> `버킷 삭제` 클릭
<img width="101" alt="스크린샷 2021-07-07 오후 11 53 08" src="https://user-images.githubusercontent.com/86812249/124787423-70bbd580-df83-11eb-8537-64237cc8c8c9.png">
<img width="848" alt="스크린샷 2021-07-07 오후 11 53 19" src="https://user-images.githubusercontent.com/86812249/124787426-71546c00-df83-11eb-8b64-fb287f651a6d.png">

삭제도 가능하네요 !
<img width="890" alt="스크린샷 2021-07-07 오후 11 53 25" src="https://user-images.githubusercontent.com/86812249/124787430-71ed0280-df83-11eb-913e-3892406a1d92.png">

이번엔 'viewuser'로 로그인 해봅시다
<img width="366" alt="스크린샷 2021-07-07 오후 11 53 57" src="https://user-images.githubusercontent.com/86812249/124787433-71ed0280-df83-11eb-8421-93b03634c706.png">

s3 -> `버킷 만들기` 클릭
<img width="146" alt="스크린샷 2021-07-07 오후 11 55 05" src="https://user-images.githubusercontent.com/86812249/124787439-731e2f80-df83-11eb-9f4c-fe883b71eb20.png">

이름 마음대로 설정 후, `버킷 만들기` 클릭
<img width="852" alt="스크린샷 2021-07-07 오후 11 55 19" src="https://user-images.githubusercontent.com/86812249/124787440-731e2f80-df83-11eb-909c-a2e7ed581757.png">
<img width="156" alt="스크린샷 2021-07-07 오후 11 55 23" src="https://user-images.githubusercontent.com/86812249/124787442-73b6c600-df83-11eb-94df-b4ccece6e0f6.png">

만들어지지 않습니다 이 IAM 계정에는 `볼 수 있는 권한`밖에 없기 때문이죠
<img width="828" alt="스크린샷 2021-07-07 오후 11 55 29" src="https://user-images.githubusercontent.com/86812249/124787447-744f5c80-df83-11eb-938a-c6062b10ce72.png">

## 실습) admin 사용자로 AWS CLI 사용하기


저는 귀찮아서 그냥 CLI 앱을 깔았습니다 
<img width="364" alt="스크린샷 2021-07-07 오후 11 57 41" src="https://user-images.githubusercontent.com/86812249/124787452-74e7f300-df83-11eb-83a8-a093bff61f46.png">

```
# aws cli 사용을 위한 자격 증명 설정
$ aws configure
AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE
AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
Default region name [None]: ap-northeast-2
Default output format [None]: table

# 자격 증명 List 확인
$ aws configure list

# VPC 정보 확인
$ aws ec2 describe-vpcs
```
<img width="480" alt="스크린샷 2021-07-08 오전 12 02 56" src="https://user-images.githubusercontent.com/86812249/124787456-75808980-df83-11eb-8989-3418247373c7.png">
<img width="512" alt="스크린샷 2021-07-08 오전 12 03 40" src="https://user-images.githubusercontent.com/86812249/124787460-76192000-df83-11eb-93fe-23c09759f3b9.png">
<img width="469" alt="스크린샷 2021-07-08 오전 12 03 49" src="https://user-images.githubusercontent.com/86812249/124787462-76192000-df83-11eb-915d-b2376b64f529.png">

## 실습) IAM Role

CloudFormation 스택 생성 클릭 후 밑에 링크 클릭
```
https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/new?stackName=IamLab&templateURL=https:%2F%2Fs3.ap-northeast-2.amazonaws.com%2Fcloudformation.cloudneta.net%2FIAM%2Fiamlab.yaml
```

맨 하단에 `다음` 클릭
<img alt="2021-07-08 오전 12 04 28" src="https://user-images.githubusercontent.com/86812249/124787466-76b1b680-df83-11eb-8f79-d98b7991a216.png">

하단에 키값 설정 후 `다음` 클릭
<img alt="스크린샷 2021-07-08 오전 12 04 43" src="https://user-images.githubusercontent.com/86812249/124787469-774a4d00-df83-11eb-804b-86a999b3ed7f.png">

기본 값으로 둔 후 -> `다음` 클릭
<img alt="스크린샷 2021-07-08 오전 12 04 49" src="https://user-images.githubusercontent.com/86812249/124787471-774a4d00-df83-11eb-9dbc-b4b25eeed46f.png">

하단에 파란박스 체크 후에 `스택 생성` 클릭
<img alt="스크린샷 2021-07-08 오전 12 04 57" src="https://user-images.githubusercontent.com/86812249/124787479-77e2e380-df83-11eb-9612-c4c3ec5f9e58.png">

만들어졌습니당
<img alt="스크린샷 2021-07-08 오전 12 05 04" src="https://user-images.githubusercontent.com/86812249/124787481-787b7a00-df83-11eb-8b42-e98cf35fb9a9.png">

EC2 -> `인스턴스` 클릭  
EC2가 생성되고 있네요 !
<img alt="스크린샷 2021-07-08 오전 12 05 52" src="https://user-images.githubusercontent.com/86812249/124787483-79141080-df83-11eb-824d-dfcf5344fb8b.png">

`S3IAMRoleEC2`에 들어가보면 IAM 역할에 `STGLabInstanceRole`이 적용된 게 보이실 겁니다
<img alt="스크린샷 2021-07-08 오전 12 06 24" src="https://user-images.githubusercontent.com/86812249/124787486-79141080-df83-11eb-9ad1-04ee3afb65aa.png">

`BasicEC2 SSH` 접속

 ```
# aws cli 사용을 위한 자격 증명 설정 (admin)
$ aws configure
AWS Access Key ID [None]: AKIAIOSFODNN7EX####
AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MD####
Default region name [None]: ap-northeast-2
Default output format [None]: table

# 자격 증명 List 확인
$ aws configure list

# ec2 조회
aws ec2 describe-instances
```
<img alt="스크린샷 2021-07-08 오전 12 06 27" src="https://user-images.githubusercontent.com/86812249/124787490-79aca700-df83-11eb-988c-c658cbbc7fed.png">
<img width="307" alt="스크린샷 2021-07-08 오전 12 11 12" src="https://user-images.githubusercontent.com/86812249/124787491-7a453d80-df83-11eb-9ea6-0b778312b2dc.png">
<img width="514" alt="스크린샷 2021-07-08 오전 12 11 33" src="https://user-images.githubusercontent.com/86812249/124787493-7a453d80-df83-11eb-8edc-57350f6c9766.png">

`S3IAMRoleEC2`에 아이디를 복사

```
# S3IAMRoleEC2 재시작
aws ec2 reboot-instances --instance-ids 'S3IAMRoleEC2'
ping 'S3IAMRoleEC2'
```
<img width="569" alt="스크린샷 2021-07-08 오전 12 12 11" src="https://user-images.githubusercontent.com/86812249/124787494-7addd400-df83-11eb-9382-06345949bf20.png">
<img alt="스크린샷 2021-07-08 오전 12 14 23" src="https://user-images.githubusercontent.com/86812249/124787497-7b766a80-df83-11eb-9b43-2a5cf94623ff.png">
<img alt="스크린샷 2021-07-08 오전 12 14 27" src="https://user-images.githubusercontent.com/86812249/124787501-7b766a80-df83-11eb-9eca-db1f36d7b47e.png">
<img width="568" alt="스크린샷 2021-07-08 오전 12 14 45" src="https://user-images.githubusercontent.com/86812249/124787503-7c0f0100-df83-11eb-9386-6c84d4f7acf2.png">
<img width="550" alt="스크린샷 2021-07-08 오전 12 14 53" src="https://user-images.githubusercontent.com/86812249/124787507-7ca79780-df83-11eb-91b5-cdb585c7796d.png">

S3IAMRoleEC2 SSH 접속 → 자격 증명 없이도 S3 사용 가능
```
# 현재 EC2에 적용된 IAM Role(EC2 Profile) 정보 확인
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/STGLabInstanceRole

# S3 버킷 조회
aws s3 ls

# S3 버킷 생성
aws s3 mb s3://버킷(유일한 이름) --region ap-northeast-2

# S3 버킷 삭제
aws s3 rm s3://버킷
```
<img width="485" alt="스크린샷 2021-07-08 오전 12 15 53" src="https://user-images.githubusercontent.com/86812249/124787509-7ca79780-df83-11eb-9a1b-e7b3d8cd3327.png">
<img width="557" alt="스크린샷 2021-07-08 오전 12 17 33" src="https://user-images.githubusercontent.com/86812249/124787513-7dd8c480-df83-11eb-995f-1b78ae0c513a.png">
<img width="290" alt="스크린샷 2021-07-08 오전 12 17 44" src="https://user-images.githubusercontent.com/86812249/124787517-7e715b00-df83-11eb-97c7-226655a547fb.png">
<img width="565" alt="스크린샷 2021-07-08 오전 12 18 17" src="https://user-images.githubusercontent.com/86812249/124787521-7e715b00-df83-11eb-93ec-b3d824d04925.png">
<img width="567" alt="스크린샷 2021-07-08 오전 12 19 28" src="https://user-images.githubusercontent.com/86812249/124787539-80d3b500-df83-11eb-9755-df3e14aa8f67.png">
<img width="300" alt="스크린샷 2021-07-08 오전 12 19 40" src="https://user-images.githubusercontent.com/86812249/124787540-816c4b80-df83-11eb-948f-1e3bc5f9c8b3.png">

```
# VPC 정보 확인
$ aws ec2 describe-vpcs
```

권한이 없어서 VPC 확인을 하지 못합니다
<img width="566" alt="스크린샷 2021-07-08 오전 12 20 04" src="https://user-images.githubusercontent.com/86812249/124787542-816c4b80-df83-11eb-81a6-ca4e5eff489f.png">

## 실습) IAM Policy

IAM → 사용자 → `admin` 클릭 →  권한에  `+ 인라인 정책 추가` 클릭
<img width="290" alt="스크린샷 2021-07-08 오전 12 20 32" src="https://user-images.githubusercontent.com/86812249/124787546-8204e200-df83-11eb-856a-4c969aef775d.png">
<img width="99" alt="스크린샷 2021-07-08 오전 12 20 48" src="https://user-images.githubusercontent.com/86812249/124787550-829d7880-df83-11eb-80e0-55de6fcbc0d9.png">
<img width="344" alt="스크린샷 2021-07-08 오전 12 20 52" src="https://user-images.githubusercontent.com/86812249/124787553-829d7880-df83-11eb-94f7-4e9a419f5c76.png">

`JSON` 클릭 후 아래 내용 입력 -> `정책 검토` 클릭

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Deny",
            "Action": [
                "ec2:RebootInstances",
                "ec2:StopInstances",
                "ec2:TerminateInstances"
            ],
            "Resource": "*"
        }
    ]
}
```

<img width="144" alt="스크린샷 2021-07-08 오전 12 21 08" src="https://user-images.githubusercontent.com/86812249/124787556-83360f00-df83-11eb-99b8-fc97c93eda88.png">
<img width="1260" alt="스크린샷 2021-07-08 오전 12 21 28" src="https://user-images.githubusercontent.com/86812249/124787558-83cea580-df83-11eb-8ad5-be23cd801764.png">

이름은 아무거나  
하단에 `정책 생성` 클릭
<img width="1254" alt="스크린샷 2021-07-08 오전 12 22 14" src="https://user-images.githubusercontent.com/86812249/124787565-84ffd280-df83-11eb-9658-623126cb434d.png">

정책이 생겼습니당
<img width="699" alt="스크린샷 2021-07-08 오전 12 22 26" src="https://user-images.githubusercontent.com/86812249/124787567-85986900-df83-11eb-9f62-91d193e188d6.png">

다시 Basic 인스턴스 CLI로 돌아간 후  

```
# ec2 조회
aws ec2 describe-instances

# S3IAMRoleEC2 재시작
aws ec2 reboot-instances --instance-ids 'S3IAMRoleEC2'
```

<img width="561" alt="스크린샷 2021-07-08 오전 12 22 52" src="https://user-images.githubusercontent.com/86812249/124787571-85986900-df83-11eb-82f8-a95f1ecb14b0.png">

재시작은 안 되는 걸 볼 수 있다. 아까 추가한 인라인 정책 중 Deny 항목에 **ec2:RebootInstances**이 있었기 때문이다
<img width="609" alt="스크린샷 2021-07-08 오전 12 25 41" src="https://user-images.githubusercontent.com/86812249/124787574-8630ff80-df83-11eb-9f17-34c8efd419ae.png">



## 자원 삭제 (중요!)
### IAM User 삭제(admin, viewuser)
### CloudFormation 삭제

<br/>
<br/>
<br/>

<hr/>

**참고 자료 : AFOS[2기] 노션 내용**