---
title:  "[AWS] 7주차-2 ALB를 통한 로드 밸런싱 실습"
subtitle:   "ALB를 통한 로드 밸런싱 실습"
date: 2021-07-21 23:00:00
categories: AWS
tags: AFOS[2기]
---

링크 접속

https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/new?stackName=ELBLab&templateURL=https:%2F%2Fcloudneta-book.s3.ap-northeast-2.amazonaws.com%2Fchapter5%2F5_lab1-AFOS.yaml

`다음` 클릭 -> `key설정` 후 `다음` 클릭 -> `다음` 클릭 -> `스택 생성` 클릭
<img width="254" alt="스크린샷 2021-07-21 오후 10 20 06" src="https://user-images.githubusercontent.com/87232411/126513896-bf1a3072-a6f7-47d1-9623-2718618982a5.png">
<img width="819" alt="스크린샷 2021-07-21 오후 10 20 29" src="https://user-images.githubusercontent.com/87232411/126513901-4dd6b737-85df-4d16-9a1d-9a80e69663b7.png">
<img width="222" alt="스크린샷 2021-07-21 오후 10 20 35" src="https://user-images.githubusercontent.com/87232411/126513903-726afd98-4287-4ba2-a97f-292363046ec2.png">
<img width="225" alt="스크린샷 2021-07-21 오후 10 20 42" src="https://user-images.githubusercontent.com/87232411/126513905-1aa5ba67-db60-4826-b121-9232e5a27338.png">

### 기본 환경 검증

ELB-EC2-1 
```bash
sudo su -
tree /var/www/html
/var/www/html
cat /var/www/html/xff.php
```

ELB-EC2-2
```bash
sudo su -
tree /var/www/html
/var/www/html
cat /var/www/html/xff.php
```
<img width="358" alt="스크린샷 2021-07-21 오후 10 32 44" src="https://user-images.githubusercontent.com/87232411/126513908-3b266227-1859-47d0-bcf3-6e94b504e938.png">
<img width="810" alt="스크린샷 2021-07-21 오후 10 33 18" src="https://user-images.githubusercontent.com/87232411/126513912-2a025826-0414-4cbe-b832-c183f93f5991.png">
<img width="336" alt="스크린샷 2021-07-21 오후 10 33 51" src="https://user-images.githubusercontent.com/87232411/126513916-48d1da1e-ac23-4575-b816-c98119159b89.png">
<img width="808" alt="스크린샷 2021-07-21 오후 10 34 18" src="https://user-images.githubusercontent.com/87232411/126513919-c8d6116c-dc9c-4288-8d28-823c01b6a93f.png">

### My-EC2 에서 확인

```
EC21= 아이피 주소
EC22= 아이피 주소
echo $EC21
echo $EC22

# ELB-EC2-1 서비스 확인
curl $EC21
curl $EC21/xff.php;echo
curl $EC21/dev/
snmpget -v2c -c public $EC21 1.3.6.1.2.1.1.5.0
snmpget -v2c -c public $EC21 1.3.6.1.2.1.1.3.0

# ELB-EC2-2 서비스 확인
curl $EC22
curl $EC22/xff.php;echo
curl $EC22/mgt/
snmpget -v2c -c public $EC22 1.3.6.1.2.1.1.5.0
```

<img width="302" alt="스크린샷 2021-07-21 오후 10 36 49" src="https://user-images.githubusercontent.com/87232411/126513921-d04951ba-14b7-47ee-9b99-7b10032429be.png">
<img width="551" alt="스크린샷 2021-07-21 오후 10 42 19" src="https://user-images.githubusercontent.com/87232411/126513923-d7609886-1c23-490e-a024-187657ebc61c.png">
<img width="538" alt="스크린샷 2021-07-21 오후 10 42 28" src="https://user-images.githubusercontent.com/87232411/126513925-2a76745d-5d76-4842-abdc-fff9148cd40f.png">
<img width="556" alt="스크린샷 2021-07-21 오후 10 43 38" src="https://user-images.githubusercontent.com/87232411/126513927-e66eb166-2e65-41ea-b05c-25773b91ac28.png">
<img width="540" alt="스크린샷 2021-07-21 오후 10 43 46" src="https://user-images.githubusercontent.com/87232411/126513929-61849ccc-ae6c-4215-b476-f9a74224b6a9.png">

### ALB 생성

`Load Banlancer 생성` 클릭 -> ALB   찾아서 `생성` 클릭 
<img width="241" alt="스크린샷 2021-07-21 오후 10 45 30" src="https://user-images.githubusercontent.com/87232411/126513932-9de2d48d-331e-430a-ad5d-9c716781c2dd.png">
<img width="391" alt="스크린샷 2021-07-21 오후 10 45 36" src="https://user-images.githubusercontent.com/87232411/126513935-09d6f355-06b6-45cc-a9fe-7d1e78c0ee30.png">

```
1. 기본 구성
    - 이름(ALB-TEST), 인터넷 경계
    - 리스너 : 프로토콜(HTTP), 포트(80)
    - 가용 영역 : ELB-VPC, 2a 와 2c 선택
2. 보안 설정 구성 : skip
3. 보안 그룹 구성 : 기존보안그룹 (###-ELBSG-### , TCP 80, 22 허용) 선택
4. 라우팅 구성
    - 대상 그룹(새 대상 그룹), 이름(ALB-TG), 대상 유형(인스턴스), 프로토콜(HTTP), 포트(80)
    - 상태 검사 → 고급 상태 검사 설정 : 정상 임계 값(3), 간격(10), 나머지는 기본값
5. 대상 등록 : 하단 인스턴스 선택 → 등록된 항목에 추가
6. 검토 → 생성
```
<img width="748" alt="스크린샷 2021-07-21 오후 10 46 31" src="https://user-images.githubusercontent.com/87232411/126513936-0af397ed-e381-4b06-9c67-48a08f3d57b9.png">
<img width="827" alt="스크린샷 2021-07-21 오후 10 47 02" src="https://user-images.githubusercontent.com/87232411/126513938-a24d4b61-e497-450c-b3f1-44a0fcbd3763.png">
<img width="181" alt="스크린샷 2021-07-21 오후 10 47 12" src="https://user-images.githubusercontent.com/87232411/126513939-6b5e92ab-2f74-41cd-be78-0a760948ded7.png">
<img width="1088" alt="스크린샷 2021-07-21 오후 10 47 30" src="https://user-images.githubusercontent.com/87232411/126513941-8aff99c3-aa20-4485-b875-37e535afe80a.png">
<img width="1078" alt="스크린샷 2021-07-21 오후 10 47 40" src="https://user-images.githubusercontent.com/87232411/126513943-8a8c15d7-dadf-4ec3-8fd8-322b055f0d0c.png">
<img width="802" alt="스크린샷 2021-07-21 오후 10 48 11" src="https://user-images.githubusercontent.com/87232411/126513945-b19f6810-8c58-414b-a22e-9d4ea2b79cb3.png">
<img width="1088" alt="스크린샷 2021-07-21 오후 10 48 34" src="https://user-images.githubusercontent.com/87232411/126513948-f44d731d-d7a4-4cc6-8c24-2c7d382b5331.png">
<img width="641" alt="스크린샷 2021-07-21 오후 10 48 51" src="https://user-images.githubusercontent.com/87232411/126513954-f88f4a2d-4306-402f-b042-6a6270a7b800.png">
<img width="1057" alt="스크린샷 2021-07-21 오후 10 49 02" src="https://user-images.githubusercontent.com/87232411/126513958-3dbbde6e-5f8c-4f45-82c9-e1875c147495.png">
<img width="157" alt="스크린샷 2021-07-21 오후 10 49 06" src="https://user-images.githubusercontent.com/87232411/126513960-8c66bd83-784c-4eb9-8477-d025d617c08e.png">
<img width="100" alt="스크린샷 2021-07-21 오후 10 49 11" src="https://user-images.githubusercontent.com/87232411/126513965-94690be9-adf7-47bc-b5e5-b39ab45e4b32.png">

EC2 -> 네트워크 및 보안 -> 네트워크 인터페이스에서 IP주소랑, 인스턴스 소유자 확인
<img width="625" alt="스크린샷 2021-07-21 오후 10 50 26" src="https://user-images.githubusercontent.com/87232411/126513968-ab5da299-fb8d-4c11-a5cd-b0a77c59fe3e.png">
<img width="569" alt="스크린샷 2021-07-21 오후 10 51 16" src="https://user-images.githubusercontent.com/87232411/126513969-f63d34cb-5228-4a65-904e-7f83b64d5857.png">

### ALB 검증

```
ALB=ALB DNS 주소
echo $ALB

# curl 접속 테스트 - ALB 는 기본 라운드 로빈 방식으로 대상 분산
dig $ALB +short
while true; do dig $ALB +short && echo "------------------------------" && date; sleep 5; done

curl $ALB
curl $ALB
for i in {1..20}; do curl $ALB --silent ; done | sort | uniq -c | sort -nr
for i in {1..100}; do curl $ALB --silent ; done | sort | uniq -c | sort -nr
curl $ALB/xff.php ;echo
curl $ALB/xff.php ;echo

# /dev/index.html 접근
curl $ALB/dev/index.html --silent
curl $ALB/dev/index.html --silent

# /mgt/index.html 접근
curl $ALB/mgt/index.html --silent
curl $ALB/mgt/index.html --silent
```
<img width="542" alt="스크린샷 2021-07-21 오후 10 52 54" src="https://user-images.githubusercontent.com/87232411/126513971-35bd0525-a98b-4042-9573-3fcd2c239604.png">
<img width="300" alt="스크린샷 2021-07-21 오후 10 53 16" src="https://user-images.githubusercontent.com/87232411/126513975-d0ea6586-08ae-4d5c-bf58-b257741e45a5.png">
<img width="567" alt="스크린샷 2021-07-21 오후 10 53 35" src="https://user-images.githubusercontent.com/87232411/126513977-cc14e79f-bef1-46cb-8d18-cdbf09d9dba3.png">
<img width="258" alt="스크린샷 2021-07-21 오후 10 54 00" src="https://user-images.githubusercontent.com/87232411/126513978-152bae5b-6716-4e88-bb5c-f86c56adf6ea.png">
<img width="564" alt="스크린샷 2021-07-21 오후 10 54 16" src="https://user-images.githubusercontent.com/87232411/126513980-85485ff1-d4f4-4c42-a02f-b8b9d9f9aeac.png">
<img width="564" alt="스크린샷 2021-07-21 오후 10 54 33" src="https://user-images.githubusercontent.com/87232411/126513983-a1cb3c39-2695-4aaa-8062-f8204d456229.png">
<img width="544" alt="스크린샷 2021-07-21 오후 10 54 52" src="https://user-images.githubusercontent.com/87232411/126513984-1bda53b2-95f0-4251-8d29-906421d96ccf.png">
<img width="656" alt="스크린샷 2021-07-21 오후 10 57 03" src="https://user-images.githubusercontent.com/87232411/126513986-1a9d27f1-29b0-49f9-91fd-59468778fe96.png">
<img width="628" alt="스크린샷 2021-07-21 오후 10 57 09" src="https://user-images.githubusercontent.com/87232411/126513989-ff79dd85-c772-4399-866d-ce142f256078.png">
<img width="669" alt="스크린샷 2021-07-21 오후 10 57 33" src="https://user-images.githubusercontent.com/87232411/126536890-78ebd884-8d2c-47ff-999e-364909bea0e3.png">
<img width="660" alt="스크린샷 2021-07-21 오후 10 57 43" src="https://user-images.githubusercontent.com/87232411/126536904-7010bf68-8409-4cbd-bed8-ab196fb06a4f.png">
<img width="407" alt="스크린샷 2021-07-21 오후 10 58 23" src="https://user-images.githubusercontent.com/87232411/126513997-e51e5189-30dc-4e44-8a7f-38770d078bd2.png">
<img width="410" alt="스크린샷 2021-07-21 오후 10 58 31" src="https://user-images.githubusercontent.com/87232411/126513999-6f28092d-c14c-4489-9ca8-dc774f868c31.png">


```
tail -f /var/log/httpd/access_log
tail -f /var/log/httpd/access_log |grep -v "ELB-HealthChecker/2.0"
tcpdump tcp port 80 -nn
```
<img width="700" alt="스크린샷 2021-07-21 오후 11 12 50" src="https://user-images.githubusercontent.com/87232411/126514001-e3efc504-ec68-4ca6-a5dc-2349a73feb1e.png">
<img width="631" alt="스크린샷 2021-07-21 오후 11 13 07" src="https://user-images.githubusercontent.com/87232411/126514002-e6efa7cb-cac5-453a-996d-14090953cc75.png">
<img width="495" alt="스크린샷 2021-07-21 오후 11 13 54" src="https://user-images.githubusercontent.com/87232411/126514006-ca870d38-b49e-4b04-9c8a-1998521ccd4c.png">

```
# Apache 기본 로그 설정 정보 확인
grep -n LogFormat /etc/httpd/conf/httpd.conf

# Apache 기본 로그 설정 변경 : 196번째 줄에 %{X-Forwarded-For}i 추가
nano /etc/httpd/conf/httpd.conf
# CTRL+X Y Enter 로 저장하고 빠져나오기

# HTTP 다시 로드 
systemctl reload httpd

# 실시간 로그 출력 후 외부에서 접속 시도
tail -f /var/log/httpd/access_log |grep -v "ELB-HealthChecker/2.0"
```
<img width="703" alt="스크린샷 2021-07-21 오후 11 14 45" src="https://user-images.githubusercontent.com/87232411/126514007-b5b94f66-a5ca-4cef-bd2f-eebfa86cba05.png">
<img width="799" alt="스크린샷 2021-07-21 오후 11 15 42" src="https://user-images.githubusercontent.com/87232411/126514009-27bef401-c872-4b63-85b8-d2afd1c74565.png">
<img width="930" alt="스크린샷 2021-07-21 오후 11 17 01" src="https://user-images.githubusercontent.com/87232411/126537302-de88651b-47ba-41c4-aacc-6a8661a6673e.png">

### 경로(Path) 기반 라우팅 설정
```
- 대상 그룹 생성 : Dev-Group(ELB-EC2-1) , Mgt-Group(ELB-EC2-2)
- 리스너 규칙 편집 : 경로 /dev/* → 전달 대상(Dev-Group) , 경로 /mgt/* → 전달 대상(Mgt-Group)
```

`Create target group` 클릭 
<img width="239" alt="스크린샷 2021-07-21 오후 11 21 50" src="https://user-images.githubusercontent.com/87232411/126514014-6e697fa0-eec1-4038-bc31-4e4873ef4db4.png">

Target group name 'Dev-Group' 입력 
<img width="954" alt="스크린샷 2021-07-21 오후 11 22 19" src="https://user-images.githubusercontent.com/87232411/126514017-f53cb9b9-3e23-4ed5-82ea-3afd1baacab1.png">

VPC `ELB-VPC`로 변경
<img width="994" alt="스크린샷 2021-07-21 오후 11 22 38" src="https://user-images.githubusercontent.com/87232411/126514020-2aed6484-a9ab-43ea-9387-6b3c3afa6a9c.png">

`Next` 클릭  
<img width="155" alt="스크린샷 2021-07-21 오후 11 22 43" src="https://user-images.githubusercontent.com/87232411/126514021-cdf090be-b80d-4802-bcf8-cc87fef4d046.png">

ALB-EC2-1 클릭 ->  `Include as pending below` 클릭 
<img width="1159" alt="스크린샷 2021-07-21 오후 11 23 22" src="https://user-images.githubusercontent.com/87232411/126514023-43d3b2a4-7409-4232-8c40-d8af5b488d38.png">

추가 됐으면 `Create target group` 클릭 


<img width="1368" alt="스크린샷 2021-07-21 오후 11 23 34" src="https://user-images.githubusercontent.com/87232411/126514028-8deb41cb-4ccf-4112-ad92-07ae38f51912.png">

Mgt-Group도 똑같이 만들기
<img width="619" alt="스크린샷 2021-07-21 오후 11 24 19" src="https://user-images.githubusercontent.com/87232411/126514029-e3d00282-c1cb-4268-91e7-2d49bd3d6647.png">

EC2 -> 로드밸런서 -> ALB-TEST 선택 후 리스너 클릭 -> `규칙 보기/편집` 클릭  
상단에 `+` 버튼 클릭
<img width="411" alt="스크린샷 2021-07-21 오후 11 25 11" src="https://user-images.githubusercontent.com/87232411/126514031-4c62d139-ba93-47b9-baa5-4017cf3ee095.png">
<img width="694" alt="스크린샷 2021-07-21 오후 11 25 24" src="https://user-images.githubusercontent.com/87232411/126514032-42b8b5fc-ecf3-4497-ac03-864dd573fa48.png">
<img width="165" alt="스크린샷 2021-07-21 오후 11 25 41" src="https://user-images.githubusercontent.com/87232411/126514033-24d32d01-454c-4e68-9b9a-660e3eda74e3.png">

`규칙 삽입` 클릭

<img width="798" alt="스크린샷 2021-07-21 오후 11 25 51" src="https://user-images.githubusercontent.com/87232411/126514036-cf1df150-780b-4c05-a9f7-97bad452b73a.png">

```
조건 -> 경로 -> 값 /dev/*
전달 대상 -> 대상 그룹: Dev-Group
```
`저장` 클릭

<img width="1272" alt="스크린샷 2021-07-21 오후 11 26 33" src="https://user-images.githubusercontent.com/87232411/126514038-11982d69-c719-41a5-9acf-76d95cc47d5a.png">

Mgt-group에도 똑같이 리스너 규칙을 추가해줍니다.
<img width="1244" alt="스크린샷 2021-07-21 오후 11 27 11" src="https://user-images.githubusercontent.com/87232411/126514041-1b5598da-1cc5-44a6-88dc-5ca06299e8b1.png">

규칙 설정 전
<img width="659" alt="스크린샷 2021-07-21 오후 11 29 28" src="https://user-images.githubusercontent.com/87232411/126514044-a12a4824-eb0f-4fa0-8d46-1129e9bcfda8.png">
<img width="701" alt="스크린샷 2021-07-21 오후 11 30 34" src="https://user-images.githubusercontent.com/87232411/126514046-8f116457-8b38-4c81-87d3-601ce08b2e8d.png">

규칙 설정 후
<img width="722" alt="스크린샷 2021-07-21 오후 11 31 54" src="https://user-images.githubusercontent.com/87232411/126514056-f95f2d99-558d-4e4b-97b9-e88fbfd76a35.png">

### HTTP 헤더 기반 라우팅 설정 - 고정 응답 반환

목적: HTTP header 에 이름이 user 이고 값이 이름인 쿠키(Cookie)가 매칭되면 고정된 응답을 반환

EC2 -> 로드밸런서 -> ALB-TEST 선택 후 리스너 클릭 -> `규칙 보기/편집` 클릭  
상단에 `+` 버튼 클릭 -> `규칙 삽입` 클릭
<img width="712" alt="스크린샷 2021-07-21 오후 11 33 21" src="https://user-images.githubusercontent.com/87232411/126514057-f56b37e6-c0ed-4718-8ffb-383218923d5a.png">
<img width="197" alt="스크린샷 2021-07-21 오후 11 33 27" src="https://user-images.githubusercontent.com/87232411/126514059-5bbdd5c2-4e35-4d6d-8615-ca8d0c53a9af.png">

```
리스너 규칙 편집 : HTTP 헤더 - Cookie 는 user=닉네임 → 고정 응답 반환 200 "Hello 닉네임"
```
<img width="1271" alt="스크린샷 2021-07-21 오후 11 34 18" src="https://user-images.githubusercontent.com/87232411/126514062-80ca9641-1e78-48d2-94db-cf1e354f3609.png">

```
curl --cookie "user=닉네임" $ALB ;echo
```
<img width="432" alt="스크린샷 2021-07-21 오후 11 35 01" src="https://user-images.githubusercontent.com/87232411/126514064-08408799-6725-4761-9a5a-0cb95e7f9b7e.png">

### 소스 IP 기반 라우팅 설정 - 고정 응답 반환

목적: 소스IP 주소가 매칭되면 고정된 응답을 반환

`규칙 삽입` 클릭
<img width="206" alt="스크린샷 2021-07-21 오후 11 35 14" src="https://user-images.githubusercontent.com/87232411/126514068-54b05f13-65ad-49a6-b0aa-9331660861e8.png">

```
리스너 규칙 편집 : 소스IP -확장='My-EC2 공인 IP입력' → 고정 응답 반환 200 "Hello EC2 Instance. Your IP address #"
```
<img width="1247" alt="스크린샷 2021-07-21 오후 11 36 34" src="https://user-images.githubusercontent.com/87232411/126514070-d2145dd5-e421-4c67-8f67-96d9bfcb6f01.png">

```
# 인터넷 사용 시 자신의 IP 주소(공인IP)를 확인하는 법
 curl -4 icanhazip.com

# 규칙 확인
curl $ALB
```
<img width="469" alt="스크린샷 2021-07-21 오후 11 37 11" src="https://user-images.githubusercontent.com/87232411/126514073-a1eff0fb-fc7c-4c97-bdad-9e1cdae8b617.png">

### Query String 기반 라우팅 설정 - 고정 응답 반환

목적: 쿼리 문자열 값이 매칭되면 고정된 응답을 반환

```
리스너 규칙 편집 : 쿼리 문자열='ABTest' → 고정 응답 반환 200 "A/B Test, option A selected"
```
<img width="1279" alt="스크린샷 2021-07-21 오후 11 38 45" src="https://user-images.githubusercontent.com/87232411/126514074-d8393ac3-d71e-4264-8ea4-688157b6d6e7.png">

```
curl $ALB
curl $ALB?ABTest=A
```
<img width="601" alt="스크린샷 2021-07-21 오후 11 39 27" src="https://user-images.githubusercontent.com/87232411/126514077-04d207ba-bd74-42aa-9012-486d90883322.png">

HTTP Request method 기반 라우팅 설정 - 고정 응답 반환

목적: HTTP 특정 메소드가 매칭되면 고정된 응답을 반환

```
리스너 규칙 편집 : HTTP 요청 메서드='READ' → 고정 응답 반환 200 "Custom READ method invoked"
```
<img width="1268" alt="스크린샷 2021-07-21 오후 11 40 16" src="https://user-images.githubusercontent.com/87232411/126514079-52870cd8-0807-4d6a-a3e3-46a4129d8b99.png">

```bash
[root@ip-172-31-7-124 ~]$ curl --request READ $ALB
Custom READ method invoked
```
<img width="346" alt="스크린샷 2021-07-21 오후 11 40 54" src="https://user-images.githubusercontent.com/87232411/126514081-d7f160b9-19a1-424b-a245-b1e46167316a.png">

###  ALB 고급 라우팅: 아이폰 사용자 차단

```
리스너 규칙:
HTTP 헤더 → **User-Agent** 는 *iPhone*
고정 응답 반환 : 503 iPhone Access Deny
```
<img width="1262" alt="스크린샷 2021-07-21 오후 11 42 36" src="https://user-images.githubusercontent.com/87232411/126514085-7ba3e249-d5b2-4499-b6eb-3b00953def39.png">

리스너 규칙 설정 전
![1](https://user-images.githubusercontent.com/87232411/126527042-62e35afe-fcfc-4490-821e-a2d5520badf3.jpeg)

리스너 규칙 설정 후
![2](https://user-images.githubusercontent.com/87232411/126527035-7c11492e-7e00-446a-89bf-b35073ecc8fc.jpeg)

### 가용성 테스트

ELB-EC2-1 인스턴스 중지
<img width="385" alt="스크린샷 2021-07-21 오후 11 58 31" src="https://user-images.githubusercontent.com/87232411/126514093-9038013d-d042-41c6-afbc-920bf0aed126.png">

ELB-1 으로 접속은 안 되네요
<img width="643" alt="스크린샷 2021-07-21 오후 11 59 28" src="https://user-images.githubusercontent.com/87232411/126514095-1db5f0c3-d80d-4879-bbec-d6eb7b7b85f0.png">

EC2 -> 대상 그룹 -> 모니터링 클릭 
<img width="455" alt="스크린샷 2021-07-22 오전 12 00 38" src="https://user-images.githubusercontent.com/87232411/126514096-59faf71e-deb3-4d65-baf2-320a4e70927c.png">

비정상 호스트 확인 -> 음 ... 잘못한 건가 
<img width="1328" alt="스크린샷 2021-07-22 오전 12 01 08" src="https://user-images.githubusercontent.com/87232411/126514101-6ee27713-bf34-4bd4-b222-49c09b6bcd0b.png">

<br/>
<br/>
<br/>

<hr/>

**참고 자료 : AFOS[2기] 노션 내용**
