---
title:  "[AWS] 7주차-3 NLB를 통한 로드 밸런싱 실습"
subtitle:   "NLB를 통한 로드 밸런싱 실습"
date: 2021-07-21 24:00:00
categories: AWS
tags: AFOS[2기]
---

## NLB 생성

EC2 -> 로드밸런서 -> `Load Balancer 생성` 클릭
<img width="200" alt="스크린샷 2021-07-22 오전 12 02 22" src="https://user-images.githubusercontent.com/87232411/126533019-7f75307b-fb26-446f-b6b7-ba8318f4dee5.png">

`생성` 클릭
<img width="386" alt="스크린샷 2021-07-22 오전 12 02 27" src="https://user-images.githubusercontent.com/87232411/126533030-2465b670-f582-4be5-9f85-227fd4d3819c.png">

```
1. 기본 구성
    - 이름(NLB-TEST), 인터넷 경계
    - 리스너 : 프로토콜(UDP), 포트(161)
    - 가용 영역 : ELB-VPC, 2a 와 2c 선택 - IP는 AWS에서 할당 or 사용자의 EIP 사용 가능
```
<img width="1136" alt="스크린샷 2021-07-22 오전 12 02 46" src="https://user-images.githubusercontent.com/87232411/126533037-4068dd8f-ca9e-4bf7-935b-3279c145bb0d.png">
<img width="982" alt="스크린샷 2021-07-22 오전 12 02 58" src="https://user-images.githubusercontent.com/87232411/126533040-bf7cfd0c-d018-4875-a2a7-100dfed4c9fb.png">

```
대상 그룹(새 대상 그룹), 이름(NLB-TG), 대상 유형(인스턴스), 프로토콜(UDP), 포트(161)
상태 검사(HTTP) → 고급 상태 검사 설정 : 간격(10), 나머지는 기본값 ⇒ UDP는 기본 단방향 통신으로 상태검사에 비적합
```
<img width="1090" alt="스크린샷 2021-07-22 오전 12 03 29" src="https://user-images.githubusercontent.com/87232411/126533044-ebed91c0-c64b-41e3-8309-22586aa41ec3.png">
<img width="943" alt="스크린샷 2021-07-22 오전 12 03 55" src="https://user-images.githubusercontent.com/87232411/126533047-da274995-74ad-4530-be1a-b3060860cc02.png">
<img width="480" alt="스크린샷 2021-07-22 오전 12 04 34" src="https://user-images.githubusercontent.com/87232411/126533049-6af0c0eb-1812-44ed-a4b0-c032dc0fc265.png">

인스턴스 선택 후 -> `Include as pending below` 클릭
<img width="1180" alt="스크린샷 2021-07-22 오후 7 47 11" src="https://user-images.githubusercontent.com/87232411/126627916-be8cb052-f7b8-4abb-a504-2ff7b0f21514.png">

하단에 `Create target group`  클릭
<img width="1348" alt="스크린샷 2021-07-22 오후 7 47 20" src="https://user-images.githubusercontent.com/87232411/126627931-fd743031-fcaa-45c9-bfcd-d9f7a9cc7d47.png">

대상 그룹 선택
<img width="1121" alt="스크린샷 2021-07-22 오전 12 05 39" src="https://user-images.githubusercontent.com/87232411/126533058-3b9367fd-c2e0-4bef-83b9-65e80bb1f821.png">

`Create load balancer` 클릭
<img width="407" alt="스크린샷 2021-07-22 오전 12 05 48" src="https://user-images.githubusercontent.com/87232411/126533061-e0f1ae19-d7a9-4e88-8bf9-ebfa734a37bd.png">

My-EC2 에서 확인
```
NLB= NLB DNS 주소
echo $NLB

# NLB는 아래 도메인 쿼리 응답 IP가 고정
dig $NLB +short
while true; do dig $NLB +short && echo "------------------------------" && date; sleep 5; done


# NLB IP를 변수에 지정 << 아래 NLB1 NLB2 IP 정보는 각자 멤버들 'dig $NLB' 출력된 IP 2개 정보를 각각 입력
NLB1=3.38.32.124
NLB2=13.124.129.65

 curl 접속 테스트
# NLB 는 5 Tuple Hash 결과로 분산하며 default 설정이 Cross Zone Load Balancing(교차 영역 로드 밸런싱)이 비활성화 상태 
for i in {1..20}; do snmpget -v2c -c public $NLB 1.3.6.1.2.1.1.5.0 ; done | sort | uniq -c | sort -nr
for i in {1..20}; do snmpget -v2c -c public $NLB1 1.3.6.1.2.1.1.5.0 ; done | sort | uniq -c | sort -nr
for i in {1..20}; do snmpget -v2c -c public $NLB2 1.3.6.1.2.1.1.5.0 ; done | sort | uniq -c | sort -nr
```
<img width="585" alt="스크린샷 2021-07-22 오전 12 06 28" src="https://user-images.githubusercontent.com/87232411/126533062-55008ca4-20a1-48ec-bc48-a9b5e2280215.png">
<img width="267" alt="스크린샷 2021-07-22 오전 12 06 36" src="https://user-images.githubusercontent.com/87232411/126533063-d4977ba3-e942-42c4-88c5-fdf081309e54.png">
<img width="717" alt="스크린샷 2021-07-22 오전 12 08 44" src="https://user-images.githubusercontent.com/87232411/126533065-6e30202b-22a5-489b-8a2a-9717c4861ea4.png">
<img width="369" alt="스크린샷 2021-07-22 오전 2 08 13" src="https://user-images.githubusercontent.com/87232411/126533066-2b7895f6-48fb-457e-9024-fb8e364b8a21.png">
<img width="299" alt="스크린샷 2021-07-22 오전 2 08 53" src="https://user-images.githubusercontent.com/87232411/126533070-a1d48b69-a36f-4210-acaa-c3b2a60e6be6.png">
<img width="559" alt="스크린샷 2021-07-22 오전 2 09 08" src="https://user-images.githubusercontent.com/87232411/126533073-43ffa4d2-9086-4264-9bff-a8085ca1b138.png">
<img width="563" alt="스크린샷 2021-07-22 오전 2 09 19" src="https://user-images.githubusercontent.com/87232411/126533074-9d45ae31-d4ed-4ca6-b743-f22edab86b37.png">
<img width="562" alt="스크린샷 2021-07-22 오전 2 09 30" src="https://user-images.githubusercontent.com/87232411/126533076-d275ff6d-afa2-4134-b561-cfd4b186b0ad.png">

ELB-EC2-1/2 에서 확인
```
# 패킷덤프 시 클라이언트IP가 NLB를 경유해서 인입하였지만 변경 안됨 - 클라이언트IP보존
# EC2 보안그룹에 NLB로 서비스하는 포트의 대상을 대부분 0.0.0.0/0 지정하게됨 - 클라이언트IP로 인입되기 때문
tcpdump udp port 161 -nn
```

**오류 수정 완료!**  
잘 나온다 ㅎㅎ 만약에 어쩌고 저쩌고 bytes 하는 글만 나온다면 My-EC2에 위에 for문 첫 번째 코드를 다시 돌려보자.
<img width="774" alt="스크린샷 2021-07-22 오후 7 52 43" src="https://user-images.githubusercontent.com/87232411/126628407-6846b507-4967-410f-90f4-def3493ee3af.png">
<img width="603" alt="스크린샷 2021-07-22 오후 7 52 52" src="https://user-images.githubusercontent.com/87232411/126628421-ca0e3cf6-bda2-47f9-83ca-a4d4d548356c.png">


### NLB Cross Zone Load Balancing 활성화

EC2 -> 로드밸런서 -> 작업 클릭 -> 속성 편집 클릭
<img width="340" alt="스크린샷 2021-07-22 오전 2 21 16" src="https://user-images.githubusercontent.com/87232411/126533084-8b961892-4822-4fda-ae78-c1613fba25a0.png">

교차 영역 로드 밸런싱 활성화 클릭
<img width="1001" alt="스크린샷 2021-07-22 오전 2 21 23" src="https://user-images.githubusercontent.com/87232411/126533086-345b68ee-a167-45fc-9adb-55b949f12132.png">

My-EC2 에서 확인

```bash
# curl 접속 테스트
for i in {1..20}; do snmpget -v2c -c public $NLB1 1.3.6.1.2.1.1.5.0 ; done | sort | uniq -c | sort -nr
for i in {1..20}; do snmpget -v2c -c public $NLB2 1.3.6.1.2.1.1.5.0 ; done | sort | uniq -c | sort -nr
```
**오류 수정 완료!**  
요즘에 오류를 고치고 성공적인 결과가 나올 때 제일 행복한 거 같다 ㅎㅎ
<img width="867" alt="스크린샷 2021-07-22 오후 8 00 18" src="https://user-images.githubusercontent.com/87232411/126629205-b6117981-6906-4e7f-97d9-d40b8798e630.png">




<hr/>

### 자원 삭제(중요!)

### 로드 밸런서 삭제 (EC2 → 로드 밸런싱 → 로드 밸런서 → 작업 → 삭제)
### 대상 그룹 삭제 (EC2 → 로드 밸런싱 → 대상 그룹 → 작업 → 삭제)
### CloudFormation 스택 삭제 (CloudFormation → 스택 → 스택 삭제)

<br/>
<br/>
<br/>

<hr/>

**참고 자료 : AFOS[2기] 노션 내용**